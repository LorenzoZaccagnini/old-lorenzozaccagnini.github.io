<!doctype html><html lang=en><head><title>Develop a Soulbound NFT using Foundry and Slither :: Thorrwulf</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Today we will develop a Soulbound NFT, an NFT that can be only minted and not traded or transferred, it is bounded to the first owner. We&amp;rsquo;ll do it using foundry with hardhat integrated. The Github workflow will test (foundry solidity and hardhat typescript) the contracts and uses Slither to statically analyze the code, trying to find the most common vulnerabilities.
You can find all the code used in my repository here"><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://lorenzozaccagnini.github.io/posts/soulbound-nft/><link rel=stylesheet href=https://lorenzozaccagnini.github.io/assets/style.css><link rel=stylesheet href=https://lorenzozaccagnini.github.io/assets/green.css><link rel=stylesheet href=https://lorenzozaccagnini.github.io/style.css><link rel=apple-touch-icon href=https://lorenzozaccagnini.github.io/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=https://lorenzozaccagnini.github.io/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Develop a Soulbound NFT using Foundry and Slither"><meta property="og:description" content="Today we will develop a Soulbound NFT, an NFT that can be only minted and not traded or transferred, it is bounded to the first owner. We&amp;rsquo;ll do it using foundry with hardhat integrated. The Github workflow will test (foundry solidity and hardhat typescript) the contracts and uses Slither to statically analyze the code, trying to find the most common vulnerabilities.
You can find all the code used in my repository here"><meta property="og:url" content="https://lorenzozaccagnini.github.io/posts/soulbound-nft/"><meta property="og:site_name" content="Thorrwulf"><meta property="og:image" content="https://lorenzozaccagnini.github.io/img/soulbound-nft-cover.jpg"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2022-08-16 00:03:47 +0200 +0200"></head><body class=green><div class="container center headings--one-size" style="margin:0 auto;border-right:none"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Thorrwulf</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/>Blog</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/>Blog</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://lorenzozaccagnini.github.io/posts/soulbound-nft/>Develop a Soulbound NFT using Foundry and Slither</a></h1><div class=post-meta><span class=post-date>2022-08-16</span>
<span class=post-reading-time>:: 9 min read (1893 words)</span></div><img src=https://lorenzozaccagnini.github.io/img/soulbound-nft-cover.jpg class=post-cover alt="Develop a Soulbound NFT using Foundry and Slither" title="Cover Image"><div class=post-content><div><p>Today we will develop a Soulbound NFT, an NFT that can be only minted and not traded or transferred, it is bounded to the first owner. We&rsquo;ll do it using foundry with hardhat integrated. The Github workflow will test <strong>(foundry solidity and hardhat typescript)</strong> the contracts and <a href=https://github.com/crytic/slither>uses Slither to statically analyze the code</a>, trying to find the most common vulnerabilities.</p><p>You can find all the code used in my repository <a href=https://github.com/LorenzoZaccagnini/Soulbound-NFT-foundry-slither>here</a></p><h2 id=1-install-foundry-and-create-the-project>1. Install Foundry and create the project<a href=#1-install-foundry-and-create-the-project class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=11-install-foundryhttpsgithubcomgakonstfoundry>1.1 Install <a href=https://github.com/gakonst/foundry>Foundry</a>.<a href=#11-install-foundryhttpsgithubcomgakonstfoundry class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L https://foundry.paradigm.xyz | sh
</span></span></code></pre></div><h3 id=12-create-the-a-new-foundry-project>1.2 Create the a new foundry project<a href=#12-create-the-a-new-foundry-project class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>forge init soulbound-nft
</span></span></code></pre></div><h3 id=13-install-the-openzeppelin-library>1.3 Install the openzeppelin library<a href=#13-install-the-openzeppelin-library class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>forge install openzeppelin/openzeppelin-contracts
</span></span></code></pre></div><h2 id=2-write-the-smart-contract>2. Write the smart contract<a href=#2-write-the-smart-contract class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Rename the smart contract in the <code>src</code> folder to <code>NFTToken.sol</code> or the name you want.</p><h3 id=21-use-a-pragma-solidity-directive-to-specify-the-compiler-version>2.1 Use a pragma solidity directive to specify the compiler version.<a href=#21-use-a-pragma-solidity-directive-to-specify-the-compiler-version class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>13</span>;
</span></span></code></pre></div><p>Use a version above 0.6.0 to avoid errors and previous vulns, like overflow and underflow. I prefer the latest stable version.</p><h3 id=22-import-the-openzeppelin-libraries>2.2 Import the openzeppelin libraries.<a href=#22-import-the-openzeppelin-libraries class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/token/ERC721/ERC721.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/access/Ownable.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/utils/Counters.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/utils/Strings.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/access/Ownable.sol&#34;</span>;
</span></span></code></pre></div><h3 id=23-inherit-from-the-erc721-and-ownable-contract>2.3 Inherit from the <code>ERC721</code> and <code>Ownable</code> contract.<a href=#23-inherit-from-the-erc721-and-ownable-contract class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>NFTToken</span> <span style=color:#66d9ef>is</span> ERC721, Ownable {
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ownable is a library that allows the contract to be owned by a single address. Later we will implement the <code>onlyOwner</code> modifier to allow only the owner to call the functions.</p><h3 id=24-setup-a-counter-for-the-token-incremental-id>2.4. Setup a counter for the token incremental id.<a href=#24-setup-a-counter-for-the-token-incremental-id class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span>    <span style=color:#f92672>using</span> Counters <span style=color:#66d9ef>for</span> Counters.Counter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Counters.Counter <span style=color:#66d9ef>private</span> _tokenIdCounter;
</span></span></code></pre></div><p>Here we are making a new counter and naming it <code>_tokenIdCounter</code>, using the <code>safemath</code> library.</p><h3 id=25-setup-the-token-name-and-symbol>2.5 Setup the token name and symbol.<a href=#25-setup-the-token-name-and-symbol class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>constructor</span>() ERC721(<span style=color:#e6db74>&#34;Soulbound&#34;</span>, <span style=color:#e6db74>&#34;SBNFT&#34;</span>) {}
</span></span></code></pre></div><p>If you feel confident you can even make a factory to create the token.</p><h3 id=26-write-the-safemint-function>2.6. Write the <code>safeMint</code> function.<a href=#26-write-the-safemint-function class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>safeMint</span>(<span style=color:#66d9ef>address</span> to) <span style=color:#66d9ef>public</span> onlyOwner {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint256</span> tokenId <span style=color:#f92672>=</span> _tokenIdCounter.current();
</span></span><span style=display:flex><span>        _tokenIdCounter.increment();
</span></span><span style=display:flex><span>        _safeMint(to, tokenId);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>This function is similar to the <code>mint</code> function in the <code>ERC721</code> contract, but it is protected by the <code>onlyOwner</code> modifier and uses the <code>_safeMint</code> function. An Internal function to safely mint a new token. Reverts if the given token ID already exists. If the target address is a contract, it must implement <code>onERC721Received</code>, which is called upon a safe transfer, and return the magic value <code>bytes4(keccak256("onERC721Received(address,address,uint256,bytes)"));</code> otherwise, the transfer is reverted. <a href=https://docs.openzeppelin.com/contracts/2.x/api/token/erc721#ERC721-_safeMint-address-uint256-bytes->Source Openzeppelin documentation</a>.</p><h3 id=27-lets-implement-the-soulbound-features>2.7 Let&rsquo;s implement the soulbound features<a href=#27-lets-implement-the-soulbound-features class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#66d9ef>modifier</span> <span style=color:#a6e22e>oneTransfer</span>(<span style=color:#66d9ef>address</span> <span style=color:#66d9ef>from</span>) {
</span></span><span style=display:flex><span>    require(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>from</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x0000000000000000000000000000000000000000</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;Soulbound nft can&#39;t be transferred&#34;</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>_</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_beforeTokenTransfer</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>address</span> <span style=color:#66d9ef>from</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>address</span> to,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint256</span> tokenId
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>override</span> oneTransfer(<span style=color:#66d9ef>from</span>) {
</span></span><span style=display:flex><span>    super._beforeTokenTransfer(<span style=color:#66d9ef>from</span>, to, tokenId);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The <code>oneTransfer</code> modifier is used to prevent the transfer of the token to any other address, the 0x0000000000000000000000000000000000000000 address it&rsquo;s an impossible from address. We implement <code>oneTransfer</code> to the <code>_beforeTokenTransfer</code> function. The <code>_beforeTokenTransfer</code> overrides the <code>_beforeTokenTransfer</code> function in the <code>ERC721</code> contract, and it is called before the transfer, now we have a soulbound nft.</p><h3 id=28-recap-the-entire-contract>2.8 Recap the entire contract.<a href=#28-recap-the-entire-contract class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// SPDX-License-Identifier: MIT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>13</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/token/ERC721/ERC721.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/access/Ownable.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/utils/Counters.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/utils/Strings.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;@openzeppelin/contracts/access/Ownable.sol&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>NFTToken</span> <span style=color:#66d9ef>is</span> ERC721, Ownable {
</span></span><span style=display:flex><span><span style=color:#f92672>using</span> Counters <span style=color:#66d9ef>for</span> Counters.Counter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Counters.Counter <span style=color:#66d9ef>private</span> _tokenIdCounter;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>constructor</span>() ERC721(<span style=color:#e6db74>&#34;Soulbound&#34;</span>, <span style=color:#e6db74>&#34;SBNFT&#34;</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>modifier</span> <span style=color:#a6e22e>oneTransfer</span>(<span style=color:#66d9ef>address</span> <span style=color:#66d9ef>from</span>) {
</span></span><span style=display:flex><span>        require(
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>from</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0x0000000000000000000000000000000000000000</span>,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;Soulbound nft can&#39;t be transferred&#34;</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>_</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>safeMint</span>(<span style=color:#66d9ef>address</span> to) <span style=color:#66d9ef>public</span> onlyOwner {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint256</span> tokenId <span style=color:#f92672>=</span> _tokenIdCounter.current();
</span></span><span style=display:flex><span>        _tokenIdCounter.increment();
</span></span><span style=display:flex><span>        _safeMint(to, tokenId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>_beforeTokenTransfer</span>(
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>address</span> <span style=color:#66d9ef>from</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>address</span> to,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>uint256</span> tokenId
</span></span><span style=display:flex><span>    ) <span style=color:#66d9ef>internal</span> <span style=color:#66d9ef>override</span> oneTransfer(<span style=color:#66d9ef>from</span>) {
</span></span><span style=display:flex><span>        super._beforeTokenTransfer(<span style=color:#66d9ef>from</span>, to, tokenId);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=3-write-foundry-tests-in-solidity>3. Write Foundry tests in solidity<a href=#3-write-foundry-tests-in-solidity class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Foundry tests are a way to test the contracts in solidity, they are really fast compared to truffle or hardhat. Foundry is made in Rust, so it&rsquo;s blazing fast. Rename the test contract file in the <code>test</code> folder to <code>NFTToken.t.sol</code>, or the name you want that respects the naming convention <code>NAMECONTRACT.t.sol</code>.</p><h3 id=31-setup-the-test-environment>3.1 Setup the test environment.<a href=#31-setup-the-test-environment class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>13</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;forge-std/Test.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;../src/NFTToken.sol&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>NFTTokenTest</span> <span style=color:#66d9ef>is</span> Test {
</span></span><span style=display:flex><span>    <span style=color:#f92672>using</span> stdStorage <span style=color:#66d9ef>for</span> StdStorage;
</span></span><span style=display:flex><span>    NFTToken <span style=color:#66d9ef>private</span> nft;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setUp</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        nft <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NFTToken();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I import the <code>Test</code> contract, and the <code>NFTToken</code> contract. NFTTokenTest is the name of the test contract. We are using the <code>stdStorage</code>, <a href=https://book.getfoundry.sh/reference/forge-std/std-storage>a library that makes manipulating storage easy</a>. <code>setUp()</code> is a function that is called before each test, and it initializes the contract.</p><h3 id=32-test-smart-contract-functions>3.2 Test Smart contract functions.<a href=#32-test-smart-contract-functions class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Here I&rsquo;m testing the smart contract functions. The pattern is easy to understand, we test the function correct output and revert if it&rsquo;s not correct with the <code>vm.expectRevert()</code> function. The <code>vm.startPrank()</code> and <code>vm.stopPrank()</code> functions are used to simulate a user that is not the owner. By using solidity to write tests we can test the smart contract functions the closest possible to a real user or external contract.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#75715e>// SPDX-License-Identifier: UNLICENSED
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>pragma solidity</span> <span style=color:#f92672>^</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>13</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;forge-std/Test.sol&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;../src/NFTToken.sol&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>contract</span> <span style=color:#a6e22e>NFTTokenTest</span> <span style=color:#66d9ef>is</span> Test {
</span></span><span style=display:flex><span><span style=color:#f92672>using</span> stdStorage <span style=color:#66d9ef>for</span> StdStorage;
</span></span><span style=display:flex><span>NFTToken <span style=color:#66d9ef>private</span> nft;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setUp</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        nft <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> NFTToken();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testDeployment</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        assertEq(nft.name(), <span style=color:#e6db74>&#34;Soulbound&#34;</span>);
</span></span><span style=display:flex><span>        assertEq(nft.symbol(), <span style=color:#e6db74>&#34;SBNFT&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testOwner</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        assertEq(nft.owner(), <span style=color:#66d9ef>address</span>(this));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testMintFailByNotOwnerUser</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        vm.expectRevert(<span style=color:#e6db74>&#34;Ownable: caller is not the owner&#34;</span>);
</span></span><span style=display:flex><span>        vm.startPrank(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>        nft.safeMint(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>        vm.stopPrank();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testMint</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        nft.safeMint(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>        assertEq(nft.balanceOf(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>1</span>)), <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        assertEq(nft.ownerOf(<span style=color:#ae81ff>0</span>), <span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>1</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testTransferFail</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        nft.safeMint(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>        vm.expectRevert(<span style=color:#e6db74>&#34;Soulbound nft can&#39;t be transferred&#34;</span>);
</span></span><span style=display:flex><span>        vm.startPrank(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>        nft.safeTransferFrom(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>), <span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>3</span>), <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        vm.stopPrank();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testOwnerTransfer</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        assertEq(nft.owner(), <span style=color:#66d9ef>address</span>(this));
</span></span><span style=display:flex><span>        nft.transferOwnership(<span style=color:#ae81ff>0x1111111111111111111111111111111111111111</span>);
</span></span><span style=display:flex><span>        assertEq(nft.owner(), <span style=color:#ae81ff>0x1111111111111111111111111111111111111111</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>testOwnerTransferFail</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span>        assertEq(nft.owner(), <span style=color:#66d9ef>address</span>(this));
</span></span><span style=display:flex><span>        vm.expectRevert(<span style=color:#e6db74>&#34;Ownable: caller is not the owner&#34;</span>);
</span></span><span style=display:flex><span>        vm.startPrank(<span style=color:#66d9ef>address</span>(<span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>        nft.transferOwnership(<span style=color:#ae81ff>0x1111111111111111111111111111111111111111</span>);
</span></span><span style=display:flex><span>        vm.stopPrank();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=33-test-contract-using-forge>3.3 Test contract using Forge<a href=#33-test-contract-using-forge class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>forge test
</span></span></code></pre></div><p>All test cases should pass.</p><h2 id=4-integrating-foundry-with-hardhat>4. Integrating Foundry with Hardhat<a href=#4-integrating-foundry-with-hardhat class=hanchor arialabel=Anchor>&#8983;</a></h2><p>Hardhat by default expects libraries to be installed in <code>node_modules</code>, the default folder for all NodeJS dependencies. Foundry expects them to be in <code>lib</code>. Of course we can configure Foundry but not easily to the directory structure of <code>node_modules</code>. <a href=https://book.getfoundry.sh/config/hardhat>Documentation</a> has more information.</p><h3 id=41-install-hardhat>4.1 Install hardhat<a href=#41-install-hardhat class=hanchor arialabel=Anchor>&#8983;</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yarn init
</span></span><span style=display:flex><span>yarn add hardhat hardhat-preprocessor
</span></span><span style=display:flex><span>npx hardhat
</span></span><span style=display:flex><span>forge remappings &gt; remappings.txt
</span></span></code></pre></div><p>You will need to re-run forge remappings everytime you modify libraries in Foundry. Now your <code>remappings.txt</code> should look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ds-test/<span style=color:#f92672>=</span>lib/solmate/lib/ds-test/src/
</span></span><span style=display:flex><span>forge-std/<span style=color:#f92672>=</span>lib/forge-std/src/
</span></span><span style=display:flex><span>openzeppelin-contracts/contracts/<span style=color:#f92672>=</span>lib/openzeppelin-contracts/contracts/
</span></span><span style=display:flex><span>solmate/<span style=color:#f92672>=</span>lib/solmate/src/
</span></span></code></pre></div><h3 id=42-configure-hardhat>4.2 Configure hardhat<a href=#42-configure-hardhat class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Edit <code>hardhat.config.ts</code> to look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>fs</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;fs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;@nomicfoundation/hardhat-chai-matchers&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;@typechain/hardhat&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#e6db74>&#34;hardhat-preprocessor&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>HardhatUserConfig</span>, <span style=color:#a6e22e>task</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;hardhat/config&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>getRemappings() {</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fs</span>
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>&#34;remappings.txt&#34;</span>, <span style=color:#e6db74>&#34;utf8&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>filter</span>(Boolean)
</span></span><span style=display:flex><span>    .<span style=color:#a6e22e>map</span>((<span style=color:#a6e22e>line</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>line</span>.<span style=color:#a6e22e>trim</span>().<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;=&#34;</span>));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>HardhatUserConfig</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>solidity</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;0.8.13&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>settings</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>optimizer</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>runs</span>: <span style=color:#66d9ef>200</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>paths</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sources</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;./src&#34;</span>, <span style=color:#75715e>// Use ./src rather than ./contracts as Hardhat expects
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cache</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;./cache_hardhat&#34;</span>, <span style=color:#75715e>// Use a different cache for Hardhat than Foundry
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  },
</span></span><span style=display:flex><span>  <span style=color:#75715e>// This fully resolves paths for imports in the ./lib directory for Hardhat
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>preprocess</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>eachLine</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>hre</span>) <span style=color:#f92672>=&gt;</span> ({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>transform</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>line</span>: <span style=color:#66d9ef>string</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>line</span>.<span style=color:#a6e22e>match</span>(<span style=color:#e6db74>/^\s*import /i</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>getRemappings</span>().<span style=color:#a6e22e>forEach</span>(([<span style=color:#a6e22e>find</span>, <span style=color:#a6e22e>replace</span>]) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>line</span>.<span style=color:#a6e22e>match</span>(<span style=color:#a6e22e>find</span>)) {
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>line</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>line</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#a6e22e>find</span>, <span style=color:#a6e22e>replace</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>line</span>;
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> <span style=color:#a6e22e>config</span>;
</span></span></code></pre></div><h2 id=5-write-hardhat-tests-in-typescript>5. Write Hardhat tests in typescript<a href=#5-write-hardhat-tests-in-typescript class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=51-create-test-contract>5.1 Create test contract<a href=#51-create-test-contract class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Create the contract in the <code>test</code> folder using this name convention <code>nfttoken.test.ts</code>.</p><h3 id=52-write-test-hardhat-file>5.2 Write test hardhat file<a href=#52-write-test-hardhat-file class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Here we do the same as the Foundry tests, but we use the hardhat <code>expect</code> and the <code>to.be.revertedWith</code> function. If the revertedWith is not recognized install the <code>"@nomicfoundation/hardhat-chai-matchers</code> package. More info <a href=https://hardhat.org/hardhat-chai-matchers/docs/overview>here</a> about this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SignerWithAddress</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@nomiclabs/hardhat-ethers/signers&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>expect</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;chai&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ethers</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;hardhat&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>NFTToken</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;../typechain-types&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#34;NFTToken&#34;</span>, <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>owner</span>: <span style=color:#66d9ef>SignerWithAddress</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>addr1</span>: <span style=color:#66d9ef>SignerWithAddress</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>addr2</span>: <span style=color:#66d9ef>SignerWithAddress</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>nft</span>: <span style=color:#66d9ef>NFTToken</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>beforeEach</span>(<span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>Nft</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>getContractFactory</span>(<span style=color:#e6db74>&#34;NFTToken&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nft</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Nft</span>.<span style=color:#a6e22e>deploy</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>deployed</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    [<span style=color:#a6e22e>owner</span>, <span style=color:#a6e22e>addr1</span>, <span style=color:#a6e22e>addr2</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>ethers</span>.<span style=color:#a6e22e>getSigners</span>();
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should return name and symbol&#34;</span>, <span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> () {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>name</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#e6db74>&#34;Soulbound&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#66d9ef>symbol</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#e6db74>&#34;SBNFT&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should set the first account as the owner&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>owner</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>owner</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should NOT mint a token as NOT the Owner&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>addr1</span>).<span style=color:#a6e22e>safeMint</span>(<span style=color:#a6e22e>addr1</span>.<span style=color:#a6e22e>address</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>revertedWith</span>(
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#34;Ownable: caller is not the owner&#34;</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should mint a token as the Owner&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>safeMint</span>(<span style=color:#a6e22e>addr1</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>ownerOf</span>(<span style=color:#ae81ff>0</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>addr1</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>balanceOf</span>(<span style=color:#a6e22e>addr1</span>.<span style=color:#a6e22e>address</span>)).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should not be able to transfer soulbound token&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>safeMint</span>(<span style=color:#a6e22e>owner</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>//OVERLOADED TRANSFER function
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>nft</span>[<span style=color:#e6db74>&#34;safeTransferFrom(address,address,uint256)&#34;</span>](
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>owner</span>.<span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>addr2</span>.<span style=color:#a6e22e>address</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>revertedWith</span>(<span style=color:#e6db74>&#34;Soulbound nft can&#39;t be transferred&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should NOT transfer the contract NON owner to the new owner&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>expect</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>addr1</span>).<span style=color:#a6e22e>transferOwnership</span>(<span style=color:#a6e22e>addr2</span>.<span style=color:#a6e22e>address</span>)
</span></span><span style=display:flex><span>    ).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>be</span>.<span style=color:#a6e22e>revertedWith</span>(<span style=color:#e6db74>&#34;Ownable: caller is not the owner&#34;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#34;Should transfer the contract owner to the new owner&#34;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>transferOwnership</span>(<span style=color:#a6e22e>addr2</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#66d9ef>await</span> <span style=color:#a6e22e>nft</span>.<span style=color:#a6e22e>owner</span>()).<span style=color:#a6e22e>to</span>.<span style=color:#a6e22e>equal</span>(<span style=color:#a6e22e>addr2</span>.<span style=color:#a6e22e>address</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Different addresses are simulated by using the <code>connect</code> function. The <code>beforeEach</code> function is used to set up the contract and the <code>it</code> function is used to test the contract.</p><h3 id=53-hardhat-vs-forge-vs-truffle>5.3 Hardhat VS Forge VS Truffle<a href=#53-hardhat-vs-forge-vs-truffle class=hanchor arialabel=Anchor>&#8983;</a></h3><p>I prefer Forge, is faster and closer to the real environment. Hardhat right now is optional, but I would recommend using it as an alternative. Truffle is now obsolete and will be less and less used in the future.</p><h2 id=6-create-a-github-workflow-with-tests-and-slither-audit>6. Create a Github workflow with tests and slither audit<a href=#6-create-a-github-workflow-with-tests-and-slither-audit class=hanchor arialabel=Anchor>&#8983;</a></h2><h3 id=61-create-a-github-workflow>6.1 Create a Github workflow<a href=#61-create-a-github-workflow class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Create a file named <code>.github/workflows/audit.yml</code> and put this content:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Audit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [<span style=color:#ae81ff>main, develop]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [<span style=color:#ae81ff>main, develop]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>submodules</span>: <span style=color:#ae81ff>recursive</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Foundry</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>foundry-rs/foundry-toolchain@v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>version</span>: <span style=color:#ae81ff>nightly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Forge build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          forge --version
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          forge build --sizes</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Forge tests</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          </span>          <span style=color:#ae81ff>forge test -vvv</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>forge-test</span>
</span></span></code></pre></div><p>This will install Foundry and run the Forge build and tests.
<img src=/img/foundry_tests.jpg alt="foundry tests" class=center style=border-radius:8px></p><h3 id=62-optional-hardat-tests>6.2 Optional Hardat tests<a href=#62-optional-hardat-tests class=hanchor arialabel=Anchor>&#8983;</a></h3><p>If you want to use hardhat add a step that uses <code>yarn</code> to instal the packages and run the command <code>npx hardhat test</code>, this will run the tests with Hardhat.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup NodeJS 14</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-node@v2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>node-version</span>: <span style=color:#e6db74>&#34;14&#34;</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Show NodeJS version</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm --version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Dependencies</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm install</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run hardhat Test</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npx hardhat compile; npx hardhat test</span>
</span></span></code></pre></div><p>Should look like this:
<img src=/img/hardhat_tests.jpg alt="Passed tests" class=center style=border-radius:8px></p><h3 id=63-add-slither-audit>6.3 Add slither audit<a href=#63-add-slither-audit class=hanchor arialabel=Anchor>&#8983;</a></h3><p>Slither is a Solidity static analysis framework written in Python 3. It runs a suite of vulnerability detectors, prints visual information about contract details, and provides an API to easily write custom analyses. Slither enables developers to find vulnerabilities, enhance their code comprehension, and quickly prototype custom analyses. <a href=https://github.com/crytic/slither>Source</a></p><p>We can even add slither manually, but I prefer to use <code>slither-action</code> command. It&rsquo;s a great tool because will push slither&rsquo;s alerts to the Security tab of the Github project, easing the triaging of findings and improving the continious integration flow.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>slither-action</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>crytic/slither-action@v0.1.1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>continue-on-error</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>id</span>: <span style=color:#ae81ff>slither</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>sarif</span>: <span style=color:#ae81ff>results.sarif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Upload SARIF file</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>github/codeql-action/upload-sarif@v2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>sarif_file</span>: <span style=color:#ae81ff>${{ steps.slither.outputs.sarif }}</span>
</span></span></code></pre></div><p>If everything is correct you will this result in the Security tab of the Github project:
<img src=/img/slither_results.jpg alt="slither results" class=center style=border-radius:8px></p><h3 id=64-recap>6.4 Recap<a href=#64-recap class=hanchor arialabel=Anchor>&#8983;</a></h3><p>They yaml file is used to create a Github workflow that will run the tests and slither audit. Should look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>name</span>: <span style=color:#ae81ff>Hardhat Build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>on</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>push</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [<span style=color:#ae81ff>main, develop]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>pull_request</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>branches</span>: [<span style=color:#ae81ff>main, develop]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>runs-on</span>: <span style=color:#ae81ff>ubuntu-latest</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>steps</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/checkout@v3</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>submodules</span>: <span style=color:#ae81ff>recursive</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Foundry</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>foundry-rs/foundry-toolchain@v1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>version</span>: <span style=color:#ae81ff>nightly</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Forge build</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          forge --version
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          forge build --sizes</span>          
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>build</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run Forge tests</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>          </span>          <span style=color:#ae81ff>forge test -vvv</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>forge-test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Setup NodeJS 14</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>actions/setup-node@v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>node-version</span>: <span style=color:#e6db74>&#34;14&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Show NodeJS version</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npm --version</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install Dependencies</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>yarn</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Run hardhat Test</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>run</span>: <span style=color:#ae81ff>npx hardhat compile; npx hardhat test</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>slither-action</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>crytic/slither-action@v0.1.1</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>continue-on-error</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>id</span>: <span style=color:#ae81ff>slither</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>sarif</span>: <span style=color:#ae81ff>results.sarif</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Upload SARIF file</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>uses</span>: <span style=color:#ae81ff>github/codeql-action/upload-sarif@v2</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>with</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>sarif_file</span>: <span style=color:#ae81ff>${{ steps.slither.outputs.sarif }}</span>
</span></span></code></pre></div></div></div></div></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2022 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script src=https://lorenzozaccagnini.github.io/assets/main.js></script>
<script src=https://lorenzozaccagnini.github.io/assets/prism.js></script></div></body></html>